<!DOCTYPE html>
<html>
  <head>
    <title>hashed.wiki</title>
    <style>
      :root {color-scheme: light dark}
      * {box-sizing: border-box}
      body {overflow: hidden}
      main {display: flex}
      iframe {flex: 2}
      html,body,main {width: 101%; height: 100%; margin: 0}
      textarea {flex: 2; font-family: monospace; white-space: pre-wrap}
    </style>
  </head>
  <body>
    <main>
      <textarea></textarea>
      <iframe></iframe>
    </main>
    <script>
      class Editor {
        constructor(name="uri") {
	  this.name = name + "s"
          this.store = name
          this.db = null
          this.$ = document.querySelector("textarea")
          this.$$ = document.querySelector("iframe")
          this.init()
        }

        async init() {
          await this.initDB()
          this.bindEvents()
          if (!location.hash) {location.hash = "home"} else {await this.load()}
          this.$.focus()
        }

        initDB() {
          return new Promise((resolve, reject) => {
            const req = indexedDB.open(this.name, 2)
            req.onupgradeneeded = (event) => {
              this.db = event.target.result
              this.db.createObjectStore(this.store, { keyPath: "key" })
            }
            req.onsuccess = (event) => {
              this.db = event.target.result
              resolve()
            }
            req.onerror = (event) => {
              console.error("DB ERROR:", event.target.errorCode)
              reject(event.target.errorCode)
            }
          })
        }

        bindEvents() {
          this.$.addEventListener("input", () => {
            clearTimeout(this.saveTimeout)
            this.saveTimeout = setTimeout(() => this.save(), 250)
          })
          window.addEventListener("hashchange", () => this.load())
        }

        update() {
          const doc = this.$$.contentDocument
          doc.open()
          doc.write("<style>:root {color-scheme: light dark; white-space: pre-wrap;} * {box-sizing: border-box;}</style>" + this.$.value)
          doc.close()
        }

        async load() {
          const hash = location.hash.slice(1) || "home"
          this.db
	    .transaction([this.store], "readonly")
	    .objectStore(this.store)
	    .get(hash).onsuccess = async (event) => {
              const res = event.target.result
              this.$.value = res ? res.value : ""
              this.update()
            }
        }

        async save() {
          const key = location.hash.slice(1) || "home"
          if (["source", "reset"].includes(key)) return
          await this.db
	    .transaction([this.store], "readwrite")
	    .objectStore(this.store)
	    .put({key, value: this.$.value})
        } 
      }

      new Editor()
    </script>
  </body>
</html>

