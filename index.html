<!DOCTYPE html>
<html>
  <head>
    <title>Editor</title>
    <style>
      /* Core styles */
      :root {
        --pad: 1em;
        color-scheme: light dark;
        --bg: #ffffff;
        --fg: #000000;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #1a1a1a;
          --fg: #ffffff;
        }
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--fg);
      }

      [contenteditable] {
        width: 100%;
        height: 100%;
        padding: var(--pad);
        overflow: auto;
        outline: none;
        font-family: system-ui, -apple-system, sans-serif;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div contenteditable></div>
    <script>
      class Editor {
        constructor() {
          this.dbName = "uris";
          this.storeName = "uri";
          this.db = null;
          this.saveTimeout = null;
          this.contentEditable = document.querySelector("[contenteditable]");

          this.init();
          this.bindEvents();
        }

        async init() {
          await this.initDB();
          if (!location.hash) {
            location.hash = "home";
          }
          this.loadContent();
        }

        initDB() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);

            request.onupgradeneeded = (event) => {
              this.db = event.target.result;
              this.db.createObjectStore(this.storeName, { keyPath: "key" });
            };

            request.onsuccess = (event) => {
              this.db = event.target.result;
              resolve();
            };

            request.onerror = (event) => {
              console.error("Database error:", event.target.errorCode);
              reject(event.target.errorCode);
            };
          });
        }

        bindEvents() {
          this.contentEditable.addEventListener("input", () => {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => this.saveContent(), 1000);
          });

          window.addEventListener("hashchange", () => this.loadContent());
        }

        async loadContent() {
          const hash = location.hash.slice(1) || "home";

          // Handle #reset
          if (hash === "reset") {
            await this.resetDB();
            location.hash = "home";
            return;
          }

          // Handle #source
          if (hash === "source") {
            const response = await fetch(location.pathname);
            const sourceCode = await response.text();
            this.contentEditable.textContent = sourceCode;
            return;
          }

          // Handle #home when empty
          if (hash === "home") {
            const transaction = this.db.transaction(
              [this.storeName],
              "readonly"
            );
            const store = transaction.objectStore(this.storeName);
            const request = store.get(hash);

            request.onsuccess = async (event) => {
              if (!event.target.result) {
                try {
                  const response = await fetch("README.md");
                  const readme = await response.text();
                  this.contentEditable.innerHTML = readme;
                  this.saveContent(); // Save README as initial content
                } catch (e) {
                  console.log("No README.md found");
                  this.contentEditable.innerHTML = "";
                }
                return;
              }
              this.contentEditable.innerHTML = event.target.result.value;
            };
            return;
          }

          // Handle regular pages
          const transaction = this.db.transaction([this.storeName], "readonly");
          const store = transaction.objectStore(this.storeName);
          const request = store.get(hash);

          request.onsuccess = (event) => {
            const result = event.target.result;
            this.contentEditable.innerHTML = result ? result.value : "";
          };
        }

        saveContent() {
          const hash = location.hash.slice(1) || "home";

          // Don't save special pages
          if (["source", "reset"].includes(hash)) return;

          const transaction = this.db.transaction(
            [this.storeName],
            "readwrite"
          );
          const store = transaction.objectStore(this.storeName);
          store.put({
            key: hash,
            value: this.contentEditable.innerHTML,
          });
        }

        async resetDB() {
          return new Promise((resolve) => {
            this.db.close();
            const req = indexedDB.deleteDatabase(this.dbName);
            req.onsuccess = () => {
              this.initDB().then(resolve);
            };
          });
        }
      }

      // Initialize the editor
      const editor = new Editor();
    </script>
  </body>
</html>
